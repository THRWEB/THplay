<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Join Solo Match - THplay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-[#111] text-white font-sans">

  <!-- ðŸ”„ Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <svg class="animate-spin h-10 w-10 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
    </svg>
  </div>

  <!-- Header -->
  <div class="relative bg-gray-900 py-3 flex items-center justify-center">
    <div class="absolute left-4 cursor-pointer" onclick="window.location.href='main.html'">
      <i data-lucide="home" class="text-white w-6 h-6"></i>
    </div>
    <h1 class="text-xl font-bold text-purple-400">THplay</h1>
    <div id="walletDisplay" onclick="window.location.href='wallet.html'" class="absolute right-4 bg-purple-700 hover:bg-purple-800 px-3 py-1 rounded-full text-sm font-semibold text-white cursor-pointer transition">
      Wallet: â‚¹0
    </div>
  </div>

  <!-- Match Card -->
  <div id="matchCard" class="bg-gray-800 rounded-xl p-4 m-4">
    <img id="matchImage" src="" class="w-full rounded mb-2" />
    <h2 id="matchTitle" class="text-xl font-bold">Loading...</h2>
    <p>Entry Fee: â‚¹<span id="matchEntryFee">--</span></p>
    <p>Prize: â‚¹<span id="matchPrize">--</span></p>
    <p>Map: <span id="matchMap">--</span></p>
    <p>Time: <span id="matchTime">--</span></p>
    <p>Slots Left: <span id="matchSlot">--</span></p>
  </div>

  <!-- Join Form -->
  <div class="m-4 p-4 bg-gray-900 rounded">
    <h3 class="text-lg font-semibold mb-2">Enter In-Game Name</h3>
    <input id="inGameName" type="text" class="w-full p-2 rounded text-black" placeholder="Your Free Fire Name"/>
    <button id="joinBtn" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded w-full">
      Join Match
    </button>
    <div id="message" class="text-center mt-4 font-semibold"></div>
    <div id="addMoneyWrapper" class="flex justify-center mt-2"></div>
  </div>

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      runTransaction, arrayUnion, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcLtCEmRCkUTwO0TaMk4piYiIHcZfjJjk",
      authDomain: "thplay-b3c68.firebaseapp.com",
      projectId: "thplay-b3c68",
      storageBucket: "thplay-b3c68.appspot.com",
      messagingSenderId: "243301774162",
      appId: "1:243301774162:web:be1d08fd88dd3edb90008b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let currentUser = null,
        entryFee = 0,
        matchId = "",
        matchCollection = "solocs",
        userWallet = 0;

    function showAddMoneyButton() {
      const wrapper = document.getElementById('addMoneyWrapper');
      wrapper.innerHTML = '';
      const addMoneyBtn = document.createElement('button');
      addMoneyBtn.textContent = 'Add Money';
      addMoneyBtn.className = 'mt-2 bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded font-semibold';
      addMoneyBtn.onclick = () => window.location.href = 'wallet.html';
      wrapper.appendChild(addMoneyBtn);
    }
    function hideAddMoneyButton() {
      document.getElementById('addMoneyWrapper').innerHTML = '';
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;

      const userRef = doc(db, "users", user.uid);

      onSnapshot(userRef, (docSnap) => {
        userWallet = docSnap.exists() ? (docSnap.data().wallet ?? 0) : 0;
        document.getElementById("walletDisplay").textContent = `Wallet: â‚¹${userWallet}`;
      });

      const match = JSON.parse(localStorage.getItem("selectedMatch"));
      if (!match?.id) {
        document.getElementById("matchCard").innerHTML =
          "<p class='text-red-500'>Match not selected or invalid.</p>";
        document.getElementById("loadingSpinner").style.display = "none";
        return;
      }
      matchId = match.id;
      matchCollection = match.collection || "solocs";
      entryFee = Number(match.entryFee) || 0;

      document.getElementById("matchImage").src = match.image || "";
      document.getElementById("matchTitle").textContent = match.title || matchId;
      document.getElementById("matchEntryFee").textContent = match.entryFee || "--";
      document.getElementById("matchPrize").textContent = match.prize || "--";
      document.getElementById("matchMap").textContent = match.map || "--";
      document.getElementById("matchTime").textContent = match.time || "--";
      document.getElementById("matchSlot").textContent = match.slot ?? "--";
      document.getElementById("loadingSpinner").style.display = "none";

      document.getElementById("joinBtn").addEventListener("click", async () => {
        const name = document.getElementById("inGameName").value.trim();
        const msg = document.getElementById("message");
        hideAddMoneyButton();
        msg.textContent = "";

        if (!name) {
          msg.innerHTML = `<span class="text-red-500">Please enter your Free Fire name.</span>`;
          return;
        }

        msg.innerHTML = `<span class="text-yellow-400">Processing...</span>`;
        document.getElementById("loadingSpinner").style.display = "flex";
        try {
          await runTransaction(db, async (tx) => {
            const matchRef = doc(db, matchCollection, matchId);
            const userRef = doc(db, "users", currentUser.uid);

            const [matchSnap, userSnap] = await Promise.all([
              tx.get(matchRef), tx.get(userRef)
            ]);

            if (!matchSnap.exists()) throw new Error("Match not found.");
            let slots = matchSnap.data()?.slot ?? 0;
            if (slots <= 0) throw new Error("No slots available.");

            let wallet = 0, joinedHistory = [];
            let joinData = { matchId, page: matchCollection, name };

            if (!userSnap.exists()) {
              // First join! Free match only, or show add money for paid
              if (entryFee > 0) {
                throw new Error("Please add money to your wallet before joining paid matches.");
              }
              // New user, so create document with this single join
              await tx.set(userRef, {
                wallet: 0,
                joinedHistory: [joinData]
              });
              slots--;
              tx.update(matchRef, { slot: slots });
              return;
            } else {
              wallet = userSnap.data().wallet ?? 0;
              joinedHistory = userSnap.data().joinedHistory || [];
              // Block joining again with SAME name in SAME match (but allow different names for same match)
              if (joinedHistory.some(j => j.matchId === matchId && j.name.toLowerCase() === name.toLowerCase())) {
                throw new Error("You have already joined this match with this in-game name.");
              }
              if (wallet < entryFee) {
                throw new Error("Not enough balance.");
              }
              slots--;
              tx.update(matchRef, { slot: slots });
              tx.update(userRef, {
                wallet: wallet - entryFee,
                joinedHistory: arrayUnion(joinData)
              });
            }
          });

          document.getElementById("loadingSpinner").style.display = "none";
          msg.innerHTML = `<span class="text-green-400">Joined successfully!${entryFee > 0 ? " â‚¹" + entryFee + " deducted." : ""}</span>`;
          document.getElementById("joinBtn").disabled = false;
          // Update slots after join
          let slotsNode = document.getElementById("matchSlot");
          slotsNode.textContent = Math.max(0, (parseInt(slotsNode.textContent) || 1) - 1);
        } catch (err) {
          document.getElementById("loadingSpinner").style.display = "none";
          msg.innerHTML = `<span class="text-red-500">${err.message || err}</span>`;
          if (err.message && err.message.includes("balance")) showAddMoneyButton();
        }
      });
    });

    lucide.createIcons();
  </script>
</body>
</html>
