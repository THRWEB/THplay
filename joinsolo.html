<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Join Match - THplay</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Poppins', sans-serif; }
    .es-card {
      background: linear-gradient(135deg, #261a36 0%, #180d25 100%);
      border-radius: 1.3rem;
      box-shadow: 0 8px 32px 0 rgba(58,28,113,0.25);
      border-left: 6px solid #a21caf;
      padding: 0.5rem 1rem 1.2rem 1rem;
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }
    .es-card .join-btn {
      font-weight: bold;
      border-radius: 9999px;
      background: linear-gradient(90deg, #ffe259 0%, #ffa751 100%);
      color: #222;
      letter-spacing: 0.03em;
      margin-top: 1.1rem;
      padding: .6rem 0;
      width: 100%;
      font-size: 1.14rem;
      box-shadow: 0 2px 8px 0 rgba(255, 165, 81, 0.12);
    }
    .es-card .es-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1.1rem;
      margin-top: .7rem;
    }
    .es-card .es-label {
      color: #a78bfa;
      font-size: 1.09rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.33rem;
    }
    .es-card .es-value {
      color: #4ade80;
      font-weight: 800;
      font-size: 1.10rem;
      text-shadow: 0 0 10px #22d3ee11;
      letter-spacing: 0.01em;
    }
    .es-card .match-title {
      color: #f3f4f6;
      font-size: 1.18rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
      margin-top: .6rem;
      text-shadow: 0 2px 12px #08080866;
      text-align: left;
    }
    .es-card .es-icon {
      width: 20px; height: 20px; display: inline-block;
      vertical-align: middle;
      filter: drop-shadow(0 0 4px #9333ea55);
    }
    .es-card-info {
      margin-top:0.2rem;
      margin-bottom:0.1rem;
    }
    .es-section-rules {
      background: linear-gradient(95deg, #321b53dd 0%, #18142bcc 100%);
      border-radius: 1rem;
      box-shadow: 0 3px 16px 0 #18102744;
      margin-bottom: 1.3rem;
      padding: 1.28rem 1.1rem 1.1rem 1.28rem;
      border-left: 6px solid #ef4444;
      max-width: 550px;
      margin-left: auto;
      margin-right: auto;
      position: relative;
      overflow: hidden;
    }
    .es-section-title {
      font-size: 1.35rem;
      font-weight: bold;
      letter-spacing: .5px;
      color: #ef4444;
      margin-bottom: 0.32rem;
      text-shadow: 0 2px 7px #ef444433;
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    @media (max-width: 480px) {
      .es-card { padding: 0.6rem 0.5rem 1rem 0.7rem }
      .es-card .es-label, .es-card .es-value { font-size: 1rem!important;}
      .es-card .match-title { font-size: 1.03rem; }
      .es-section-rules { max-width: 98vw; padding: 1.03rem .55rem .9rem .77rem; }
      .es-section-title { font-size: 1.08rem; }
    }
  </style>
</head>
<body class="bg-gradient-to-b from-indigo-950 via-black to-zinc-900 min-h-screen text-white">

  <!-- üîÑ Loading Spinner -->
  <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <svg class="animate-spin h-10 w-10 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/>
    </svg>
  </div>

  <!-- Header -->
  <div class="fixed top-0 w-full z-40 bg-gradient-to-r from-purple-900 via-indigo-900 to-gray-900 py-3 flex items-center justify-center shadow-md">
    <div class="absolute left-4 cursor-pointer" onclick="window.location.href='main.html'">
      <i data-lucide="home" class="text-white w-6 h-6"></i>
    </div>
    <h1 class="text-xl md:text-2xl font-bold text-purple-400 tracking-wide drop-shadow">THplay</h1>
    <div id="walletDisplay" class="absolute right-4 bg-purple-700 hover:bg-purple-800 transition px-3 py-1 rounded-full text-sm font-semibold text-white cursor-pointer">
      Wallet: ‚Çπ0
    </div>
  </div>

  <!-- Match Card (design - esports neon match) -->
  <div class="pt-20 max-w-md mx-auto p-2">
    <div id="matchCard" class="es-card">
      <div style="display:flex;align-items:center;gap:0.8rem;">
        <img id="matchImage" src="" class="rounded-lg object-cover w-20 h-20 border-2 border-purple-800 shadow" style="flex-shrink:0;" />
        <div class="match-title" id="matchTitle">Loading...</div>
      </div>
      <div class="es-card-info">
        <div class="es-row">
          <span class="es-label">
            <svg class="es-icon" viewBox="0 0 21 21"><circle cx="10.5" cy="10.5" r="8" fill="#818cf8"/><text x="10.5" y="15" text-anchor="middle" fill="#fff" font-size="11" font-weight="bold">‚Çπ</text></svg>
            Entry Fee:
          </span>
          <span class="es-value" id="matchEntryFee">--</span>
        </div>
        <div class="es-row">
          <span class="es-label">
            <svg class="es-icon" viewBox="0 0 22 22"><circle cx="11" cy="11" r="8" fill="#fbbf24"/><text x="11" y="15" text-anchor="middle" fill="#1c1917" font-size="10" font-weight="bold">üèÜ</text></svg>
            Prize:
          </span>
          <span class="es-value" id="matchPrize">--</span>
        </div>
        <div class="es-row">
          <span class="es-label">
            <svg class="es-icon" viewBox="0 0 22 22"><circle cx="11" cy="11" r="8" fill="#4ade80"/><text x="11" y="15" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">‚è∞</text></svg>
            Time:
          </span>
          <span class="es-value" id="matchTime">--</span>
        </div>
        <div class="es-row">
          <span class="es-label">
            <svg class="es-icon" viewBox="0 0 22 22"><circle cx="11" cy="11" r="8" fill="#0ea5e9"/><text x="11" y="15" text-anchor="middle" fill="#fff" font-size="10" font-weight="bold">üó∫</text></svg>
            Map:
          </span>
          <span class="es-value" id="matchMap">--</span>
        </div>
        <div class="es-row">
          <span class="es-label">
            <svg class="es-icon" viewBox="0 0 22 22"><circle cx="11" cy="11" r="8" fill="#f472b6"/><text x="11" y="15" text-anchor="middle" fill="#a21caf" font-size="10" font-weight="bold">üë§</text></svg>
            Slots Left:
          </span>
          <span class="es-value" id="matchSlot">--</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Join Form (dynamically renders correct input fields) -->
  <div class="m-4 p-4 bg-gray-900 rounded max-w-md mx-auto">
    <h3 class="text-lg font-semibold mb-2">Enter In-Game Name(s)</h3>
    <div id="nameFields"></div>
    <p id="feeInfo" class="mt-2 text-lg font-semibold text-yellow-400"></p>
    <button id="joinBtn" class="mt-4 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-4 rounded w-full">
      Join Match
    </button>
    <div id="message" class="text-center mt-4 font-semibold"></div>
    <div id="addMoneyWrapper" class="flex justify-center mt-2"></div>
  </div>

  <!-- Match Rules Section - Esports Card, Red color -->
  <section class="es-section-rules my-8">
    <div class="es-section-title">
      <svg xmlns="http://www.w3.org/2000/svg" class="inline-block w-6 h-6" fill="#ef4444" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" />
        <text x="12" y="17" font-size="13" fill="#fff" font-family="sans-serif" text-anchor="middle">!</text>
      </svg>
      Match Rules
    </div>
    <ul class="list-disc list-inside space-y-2 text-gray-200 text-base mt-2 mb-3 pl-2">
      <li><span class="font-bold text-red-400">No usage of mod apps or hacks</span>. Players using any unfair advantage will be disqualified instantly.</li>
      <li><span class="font-bold text-red-400">Headshot rate must not exceed 50%.</span> Suspicious stats will be reviewed and may result in disqualification.</li>
      <li><span class="font-bold text-red-400">Do not change your slot.</span> The slot assigned to you after joining must be used for the match.</li>
      <li><span class="font-bold text-red-400">Abusive language is prohibited.</span> Any form of abuse, hate speech, or offensive chat may result in suspension or ban.</li>
      <li><span class="font-bold text-red-400">Respect all players and organizers.</span></li>
      <li><span class="font-bold text-red-400">If you are killed by hackers, record your gameplay and contact support to complain.</span> If cheating is proven with your gameplay, you will get a full refund for that match.</li>
      <li><span class="font-bold text-red-400">The Free Fire ID you use must be at least Level 15.</span> Lower level IDs are not allowed.</li>
    </ul>
    <p class="mt-4 text-sm text-gray-400 italic">Breaking any rule may lead to removal, account suspension, or refund denial. Play fair and enjoy the competition!</p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, runTransaction, arrayUnion, onSnapshot
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBcLtCEmRCkUTwO0TaMk4piYiIHcZfjJjk",
      authDomain: "thplay-b3c68.firebaseapp.com",
      projectId: "thplay-b3c68",
      storageBucket: "thplay-b3c68.appspot.com",
      messagingSenderId: "243301774162",
      appId: "1:243301774162:web:be1d08fd88dd3edb90008b"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    let currentUser = null, entryFee = 0, matchId = "", matchCollection = "solocs", maxNames = 1;

    function showAddMoneyButton() {
      const wrapper = document.getElementById('addMoneyWrapper');
      wrapper.innerHTML = '';
      const addMoneyBtn = document.createElement('button');
      addMoneyBtn.textContent = 'Add Money';
      addMoneyBtn.className = 'mt-2 bg-purple-700 hover:bg-purple-800 text-white px-4 py-2 rounded font-semibold';
      addMoneyBtn.onclick = () => window.location.href = 'wallet.html';
      wrapper.appendChild(addMoneyBtn);
    }
    function hideAddMoneyButton() {
      document.getElementById('addMoneyWrapper').innerHTML = '';
    }

    // ==== Ensure wallet.html opens on click ====
    window.addEventListener('DOMContentLoaded', () => {
      const walletBtn = document.getElementById("walletDisplay");
      if(walletBtn) walletBtn.onclick = () => window.location.href = "wallet.html";
    });

    // RENDER THE INPUT FIELDS, DYNAMICALLY BASED ON MATCH MODE
    function renderNameFields() {
      const nameFieldsDiv = document.getElementById('nameFields');
      nameFieldsDiv.innerHTML = '';
      let fields = [];
      for (let i=1; i<=maxNames; i++) {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.id = `inGameName${i}`;
        inp.placeholder = `Player Name ${i}${i===1?' (required)':' (optional)'}`;
        inp.className = "w-full p-2 my-2 rounded text-black";
        nameFieldsDiv.appendChild(inp);
        fields.push(inp);
        inp.addEventListener('input', updateFeeInfo);
      }
      return fields;
    }
    function updateFeeInfo() {
      const fields = Array.from(document.querySelectorAll('#nameFields input'));
      const filled = fields.filter(f => f.value.trim()).length;
      document.getElementById("feeInfo").textContent =
        `Total Entry Fee: ‚Çπ${entryFee * (filled || 1)}` +
        (maxNames > 1 ? ` (${filled} slot${filled>1?'s':''})` : '');
    }

    // ----- On Auth -----
    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "index.html";
      currentUser = user;
      const userDocRef = doc(db, "users", user.uid);

      onSnapshot(userDocRef, (snap) => {
        let amt = (snap.exists() ? snap.data().wallet : 0) || 0;
        document.getElementById("walletDisplay").textContent = "Wallet: ‚Çπ" + amt;
      });

      // ------ Load Match ------
      const match = JSON.parse(localStorage.getItem("selectedMatch"));
      if (!match?.id) {
        document.getElementById("matchCard").innerHTML = "<p class='text-red-500'>Match not selected or invalid.</p>";
        document.getElementById("loadingSpinner").style.display = "none";
        return;
      }
      matchId = match.id;
      matchCollection = match.collection || "solocs";
      entryFee = Number(match.entryFee) || 0;

      // Decide mode/number of fields
      if (["soloc", "solocs"].includes(matchCollection)) maxNames = 1;
      else if (["duoc", "duocs"].includes(matchCollection)) maxNames = 2;
      else if (["squadc", "squadcs"].includes(matchCollection)) maxNames = 4;
      else maxNames = 1;

      document.getElementById("matchImage").src = match.image || "";
      document.getElementById("matchTitle").textContent = match.title || matchId;
      document.getElementById("matchEntryFee").textContent = match.entryFee || "--";
      document.getElementById("matchPrize").textContent = match.prize || "--";
      document.getElementById("matchMap").textContent = match.map || "--";
      document.getElementById("matchTime").textContent = match.matchTime || "--";
      document.getElementById("matchSlot").textContent = match.slot ?? "--";
      document.getElementById("loadingSpinner").style.display = "none";

      // RENDER fields for this mode
      const nameInputs = renderNameFields();
      updateFeeInfo();

      // ------ JOIN BUTTON ------
      document.getElementById("joinBtn").addEventListener("click", async () => {
        const msg = document.getElementById("message");
        hideAddMoneyButton();
        msg.textContent = "";

        // Gather names (remove empty)
        let names = nameInputs.map(inp => inp.value.trim()).filter(n => n);
        // Remove duplicates (case insensitive)
        names = Array.from(new Set(names.map(n => n.toLowerCase()))).map(n =>
          nameInputs.find(inp => inp.value.trim().toLowerCase() === n)?.value.trim()
        );
        if (names.length < 1) {
          msg.innerHTML = `<span class="text-red-500">Please enter at least one in-game name.</span>`;
          return;
        }
        msg.innerHTML = `<span class="text-yellow-400">Processing...</span>`;
        document.getElementById("loadingSpinner").style.display = "flex";
        try {
          await runTransaction(db, async (tx) => {
            // 1. Match doc
            const matchRef = doc(db, matchCollection, matchId);
            const matchSnap = await tx.get(matchRef);
            if (!matchSnap.exists()) throw new Error("Match not found.");
            let slots = matchSnap.data()?.slot ?? 0;
            if (slots < names.length) throw new Error("Not enough slots available.");
            let joinedPlayers = matchSnap.data().joinedPlayers || [];
            for (const name of names) {
              if (joinedPlayers.some(j => j.uid === currentUser.uid && j.name.toLowerCase() === name.toLowerCase())) {
                throw new Error(`You have already joined this match with "${name}".`);
              }
            }

            // 2. User doc (for wallet check & update)
            const userDocRef = doc(db, "users", currentUser.uid);
            let userSnap = await tx.get(userDocRef);
            let wallet = 0;
            if (!userSnap.exists()) {
              if (entryFee * names.length > 0) {
                throw new Error("Please add money to your wallet before joining paid matches.");
              }
              await tx.set(userDocRef, { wallet: 0 });
              wallet = 0;
            } else {
              wallet = userSnap.data().wallet ?? 0;
              if (wallet < entryFee * names.length) {
                throw new Error("Not enough wallet balance.");
              }
            }

            // 3. Update both: deduct fee, add join record to match doc
            tx.update(matchRef, {
              slot: slots - names.length,
              joinedPlayers: arrayUnion(...names.map(name => ({
                uid: currentUser.uid,
                name,
              })))
            });
            if (entryFee * names.length > 0) {
              tx.update(userDocRef, { wallet: wallet - entryFee * names.length });
            }
          });

          document.getElementById("loadingSpinner").style.display = "none";
          msg.innerHTML = `<span class="text-green-400">Joined successfully!${entryFee > 0 ? " ‚Çπ" + (entryFee * names.length) + " deducted." : ""}</span>`;
          let slotsNode = document.getElementById("matchSlot");
          slotsNode.textContent = Math.max(0, (parseInt(slotsNode.textContent) || names.length) - names.length);

        } catch (err) {
          document.getElementById("loadingSpinner").style.display = "none";
          msg.innerHTML = `<span class="text-red-500">${err.message || err}</span>`;
          if (err.message && err.message.includes("balance")) showAddMoneyButton();
        }
      });
    });

    lucide.createIcons();
  </script>
</body>
</html>
